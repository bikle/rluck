
SQL*Plus: Release 11.2.0.1.0 Production on Tue Nov 9 03:02:40 2010

Copyright (c) 1982, 2009, Oracle.  All rights reserved.


Connected to:
Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options

03:02:40 SQL> ALTER SESSION SET NLS_DATE_FORMAT = 'YYYY-MM-DD hh24:mi:ss';

Session altered.

Elapsed: 00:00:00.00
03:02:40 SQL> 03:02:40 SQL> --
03:02:40 SQL> -- 12hp.sql
03:02:40 SQL> --
03:02:40 SQL> 
03:02:40 SQL> SET LINES 66
03:02:40 SQL> DESC hourly
 Name				  Null?    Type
 -------------------------------- -------- -----------------------
 PAIR					   VARCHAR2(15)
 YDATE					   DATE
 VOL					   NUMBER
 OPN					   NUMBER
 CLSE					   NUMBER
 MN					   NUMBER
 MX					   NUMBER

03:02:40 SQL> SET LINES 166
03:02:40 SQL> 
03:02:40 SQL> CREATE OR REPLACE VIEW hp10 AS
03:02:40   2  SELECT
03:02:40   3  pair
03:02:40   4  -- ydate is granular down to the hour:
03:02:40   5  ,ydate
03:02:40   6  ,opn
03:02:40   7  -- Derive an attribute I call "day_hour":
03:02:40   8  ,TO_CHAR(ydate,'D')||'_'||TO_CHAR(ydate,'HH24')dhr
03:02:40   9  -- Get ydate 12 hours in the future:
03:02:40  10  ,LEAD(ydate,12,NULL)OVER(PARTITION BY pair ORDER BY pair,ydate) ydate12
03:02:40  11  -- Get closing price 12 hours in the future:
03:02:40  12  ,LEAD(clse,11,NULL)OVER(PARTITION BY pair ORDER BY pair,ydate) clse12
03:02:40  13  FROM hourly
03:02:40  14  WHERE ydate > '2009-01-01'
03:02:40  15  -- Prevent divide by zero:
03:02:40  16  AND opn > 0
03:02:40  17  ORDER BY pair,ydate
03:02:40  18  /

View created.

Elapsed: 00:00:00.05
03:02:40 SQL> 
03:02:40 SQL> -- I derive more attributes:
03:02:40 SQL> CREATE OR REPLACE VIEW hp12 AS
03:02:40   2  SELECT
03:02:40   3  pair
03:02:40   4  ,ydate
03:02:40   5  ,opn
03:02:40   6  ,dhr
03:02:40   7  ,ydate12
03:02:40   8  ,clse12
03:02:40   9  ,(clse12 - opn)/opn npg
03:02:40  10  FROM hp10
03:02:40  11  ORDER BY pair,ydate
03:02:40  12  /

View created.

Elapsed: 00:00:00.04
03:02:40 SQL> 
03:02:40 SQL> --rpt
03:02:40 SQL> SELECT COUNT(ydate)FROM hp10;

COUNT(YDATE)
------------
       69918

Elapsed: 00:00:00.24
03:02:40 SQL> SELECT AVG(ydate12 - ydate), MIN(ydate12 - ydate),MAX(ydate12 - ydate),COUNT(ydate)FROM hp12;

AVG(YDATE12-YDATE) MIN(YDATE12-YDATE) MAX(YDATE12-YDATE) COUNT(YDATE)
------------------ ------------------ ------------------ ------------
	.697233915		   .5	      2.95833333	69918

Elapsed: 00:00:00.36
03:02:41 SQL> -- I should see no rows WHERE the date difference is less than 12 hours:
03:02:41 SQL> SELECT COUNT(ydate)FROM hp12 WHERE (ydate12 - ydate) < 0.5;

COUNT(YDATE)
------------
	   0

Elapsed: 00:00:00.27
03:02:41 SQL> 
03:02:41 SQL> -- I should see many rows WHERE the date difference is exactly 12 hours:
03:02:41 SQL> SELECT COUNT(ydate)FROM hp12 WHERE (ydate12 - ydate) = 0.5;

COUNT(YDATE)
------------
       62532

Elapsed: 00:00:00.27
03:02:41 SQL> 
03:02:41 SQL> -- I should see some rows
03:02:41 SQL> -- WHERE the date difference is greater than 12 hours due to Saturday getting sandwiched between some of the records.
03:02:41 SQL> -- Also if I am missing some rows, counts will appear here:
03:02:41 SQL> SELECT TO_CHAR(ydate,'Day'),MIN(ydate),COUNT(ydate),MAX(ydate)
03:02:41   2  FROM hp12 WHERE (ydate12 - ydate) > 0.5
03:02:41   3  GROUP BY TO_CHAR(ydate,'Day')
03:02:41   4  ORDER BY COUNT(ydate)
03:02:41   5  /

TO_CHAR(Y MIN(YDATE)	      COUNT(YDATE) MAX(YDATE)
--------- ------------------- ------------ -------------------
Sunday	  2009-05-10 21:00:00		18 2009-05-10 23:00:00
Monday	  2009-05-11 00:00:00		18 2009-05-11 02:00:00
Thursday  2009-06-25 04:00:00		72 2009-06-25 15:00:00
Wednesday 2010-06-23 07:00:00		72 2010-06-23 18:00:00
Tuesday   2009-07-14 02:00:00	       144 2009-08-18 21:00:00
Friday	  2009-01-02 10:00:00	      6990 2010-11-05 21:00:00

6 rows selected.

Elapsed: 00:00:00.28
03:02:41 SQL> 
03:02:41 SQL> -- Now I can aggregate:
03:02:41 SQL> CREATE OR REPLACE VIEW hdp AS
03:02:41   2  SELECT
03:02:41   3  pair
03:02:41   4  ,ydate
03:02:41   5  ,opn
03:02:41   6  ,dhr
03:02:41   7  ,ydate12
03:02:41   8  ,clse12
03:02:41   9  ,npg
03:02:41  10  FROM hp12
03:02:41  11  WHERE (ydate12 - ydate) = 0.5
03:02:41  12  /

View created.

Elapsed: 00:00:00.04
03:02:41 SQL> 
03:02:41 SQL> -- The query below gives me an idea of the scale of each aggregation:
03:02:41 SQL> SELECT
03:02:41   2  dhr
03:02:41   3  ,COUNT(npg)count_npg
03:02:41   4  ,ROUND(SUM(npg),4)sum_npg
03:02:41   5  ,ROUND(MIN(npg),4)min_npg
03:02:41   6  ,ROUND(AVG(npg),4)avg_npg
03:02:41   7  ,ROUND(MAX(npg),4)max_npg
03:02:41   8  ,ROUND(STDDEV(npg),4)stddev_npg
03:02:41   9  FROM hdp
03:02:41  10  GROUP BY dhr
03:02:41  11  ORDER BY dhr
03:02:41  12  /

DHR   COUNT_NPG    SUM_NPG    MIN_NPG	 AVG_NPG    MAX_NPG STDDEV_NPG
---- ---------- ---------- ---------- ---------- ---------- ----------
1_21	    569     -.0601     -.0216	  -.0001      .0224	 .0058
1_22	    569     -.0833     -.0243	  -.0001      .0208	 .0055
1_23	    569     -.0366     -.0238	  -.0001      .0212	 .0058
2_00	    575     -.0152     -.0225	       0      .0308	 .0059
2_01	    575      .0003     -.0277	       0       .034	  .006
2_02	    575     -.0458     -.0249	  -.0001      .0296	 .0059
2_03	    575     -.0294     -.0266	  -.0001      .0216	 .0062
2_04	    575     -.0304	-.026	  -.0001      .0224	 .0066
2_05	    575     -.0567	-.027	  -.0001      .0259	 .0065
2_06	    575      .0041     -.0288	       0      .0274	 .0065
2_07	    582      .0052     -.0286	       0      .0293	 .0064
2_08	    582      .0132     -.0236	       0      .0306	 .0063
2_09	    582      .0144     -.0253	       0      .0222	 .0058
2_10	    576      .0262     -.0229	       0       .021	 .0057
2_11	    576     -.0323     -.0215	  -.0001      .0204	 .0054
2_12	    576     -.1276     -.0236	  -.0002      .0179	 .0053
2_13	    576     -.1921	-.023	  -.0003      .0185	 .0051
2_14	    576     -.1243     -.0193	  -.0002      .0205	 .0049
2_15	    576     -.1531     -.0169	  -.0003      .0181	 .0044
2_16	    576     -.1052     -.0224	  -.0002      .0179	 .0043
2_17	    576     -.1423     -.0223	  -.0002      .0163	 .0041
2_18	    576     -.1565     -.0189	  -.0003      .0165	 .0043
2_19	    576     -.1937     -.0242	  -.0003      .0185	 .0046
2_20	    576     -.1872     -.0239	  -.0003	.02	 .0051
2_21	    576     -.2124     -.0288	  -.0004      .0224	 .0054
2_22	    576     -.2348	-.031	  -.0004      .0189	 .0056
2_23	    576     -.1759     -.0256	  -.0003      .0203	 .0057
3_00	    576     -.1334     -.0344	  -.0002      .0186	 .0061
3_01	    576     -.0613     -.0237	  -.0001      .0229	 .0061
3_02	    570     -.0495     -.0222	  -.0001       .021	 .0061
3_03	    570      .0018     -.0247	       0      .0209	 .0064
3_04	    570     -.0011     -.0229	       0      .0214	 .0065
3_05	    570     -.0041     -.0186	       0      .0201	 .0065
3_06	    570      .0209     -.0197	       0      .0233	 .0067
3_07	    570      .0243     -.0268	       0      .0229	 .0072
3_08	    570      .0314     -.0324	   .0001      .0263	 .0071
3_09	    570      .0441     -.0273	   .0001      .0218	 .0068
3_10	    564      .0437     -.0209	   .0001      .0239	 .0066
3_11	    564      .0575     -.0231	   .0001      .0244	 .0062
3_12	    564       .071     -.0226	   .0001      .0219	  .006
3_13	    564     -.0629     -.0258	  -.0001      .0213	 .0059
3_14	    564     -.0371     -.0261	  -.0001      .0222	 .0054
3_15	    570     -.0435     -.0235	  -.0001      .0177	  .005
3_16	    570     -.0797     -.0236	  -.0001      .0212	 .0047
3_17	    570     -.0574     -.0201	  -.0001      .0243	 .0044
3_18	    570     -.0471     -.0138	  -.0001      .0213	  .004
3_19	    570     -.0119     -.0133	       0      .0316	  .004
3_20	    570      .0215     -.0218	       0      .0285	 .0042
3_21	    570      .0777     -.0192	   .0001      .0288	 .0044
3_22	    570      .0552     -.0217	   .0001      .0276	 .0046
3_23	    570      .0524     -.0233	   .0001      .0254	 .0047
4_00	    570      .0393     -.0186	   .0001      .0268	 .0049
4_01	    570      .1723     -.0142	   .0003      .0317	 .0051
4_02	    570      .1115     -.0227	   .0002       .018	 .0056
4_03	    576      .1519     -.0173	   .0003      .0174	 .0059
4_04	    576      .1032	-.026	   .0002       .022	 .0065
4_05	    576      .1613     -.0286	   .0003      .0279	 .0069
4_06	    576      .1189     -.0343	   .0002      .0271	 .0072
4_07	    570      .0715     -.0354	   .0001      .0332	 .0077
4_08	    570      .0688     -.0345	   .0001      .0371	 .0076
4_09	    570      .0592     -.0339	   .0001      .0366	 .0075
4_10	    570      .0872     -.0319	   .0002      .0362	  .007
4_11	    570      .0822     -.0291	   .0001       .034	 .0066
4_12	    570      .0991	-.029	   .0002      .0351	 .0061
4_13	    570      .1305     -.0226	   .0002      .0252	 .0057
4_14	    570      .1328     -.0205	   .0002      .0237	 .0054
4_15	    570     -.0035     -.0208	       0      .0227	  .005
4_16	    570      .0403     -.0214	   .0001      .0266	 .0053
4_17	    570      .0034     -.0214	       0      .0249	 .0051
4_18	    570      .0404     -.0262	   .0001      .0253	  .005
4_19	    570      .1343     -.0198	   .0002      .0193	 .0047
4_20	    576      .0663     -.0187	   .0001      .0175	 .0045
4_21	    576      .0254     -.0189	       0      .0152	 .0049
4_22	    576      .1037     -.0224	   .0002      .0201	 .0055
4_23	    576      .0909     -.0223	   .0002      .0199	 .0056
5_00	    576       .033     -.0236	   .0001      .0178	 .0056
5_01	    582      .1091     -.0213	   .0002	.02	 .0061
5_02	    582      .1595     -.0199	   .0003      .0319	 .0064
5_03	    582      .1747     -.0303	   .0003      .0315	 .0069
5_04	    576      .2112     -.0224	   .0004      .0314	  .007
5_05	    576      .1478     -.0293	   .0003      .0326	  .007
5_06	    576      .1995     -.0229	   .0003      .0286	 .0069
5_07	    576      .1495     -.0472	   .0003      .0247	 .0072
5_08	    576      .2012     -.0359	   .0003       .022	 .0071
5_09	    576      .1716     -.0353	   .0003      .0237	 .0069
5_10	    576      .1233     -.0309	   .0002      .0269	 .0064
5_11	    576      .1434     -.0321	   .0002      .0276	 .0061
5_12	    576       .159     -.0271	   .0003      .0267	 .0061
5_13	    576     -.0056     -.0219	       0      .0232	 .0056
5_14	    576     -.0748     -.0204	  -.0001      .0181	 .0054
5_15	    576     -.0378     -.0194	  -.0001      .0195	  .005
5_16	    576     -.0003     -.0231	       0      .0271	 .0046
5_17	    576      .0633     -.0167	   .0001      .0267	 .0042
5_18	    576     -.0025     -.0173	       0      .0284	 .0042
5_19	    576      .0016     -.0142	       0       .029	 .0041
5_20	    576     -.0095     -.0191	       0      .0254	 .0045
5_21	    576      .1049     -.0173	   .0002      .0168	 .0047
5_22	    576     -.0136     -.0221	       0      .0207	 .0052
5_23	    576     -.0776     -.0235	  -.0001      .0214	 .0054
6_00	    576     -.0168     -.0209	       0      .0191	 .0055
6_01	    576      .0111     -.0242	       0      .0206	 .0057
6_02	    576      .0783	-.019	   .0001       .019	 .0057
6_03	    576      .0747     -.0191	   .0001      .0304	  .006
6_04	    576      .0484     -.0193	   .0001      .0275	 .0066
6_05	    576     -.0122     -.0222	       0      .0296	 .0066
6_06	    576       .018     -.0227	       0      .0347	 .0069
6_07	    576      .0052     -.0294	       0      .0377	 .0075
6_08	    575      .0366     -.0291	   .0001      .0313	 .0076
6_09	    575     -.0286     -.0278	       0      .0291	 .0073

109 rows selected.

Elapsed: 00:00:00.60
03:02:42 SQL> 
03:02:42 SQL> -- The above aggregation is interesting but it shows no pairs.
03:02:42 SQL> -- I need to know about pairs:
03:02:42 SQL> SELECT
03:02:42   2  pair,dhr
03:02:42   3  ,COUNT(npg)count_npg
03:02:42   4  ,ROUND(MIN(npg),4)min_npg
03:02:42   5  ,ROUND(AVG(npg),4)avg_npg
03:02:42   6  ,ROUND(STDDEV(npg),4)stddev_npg
03:02:42   7  ,ROUND(MAX(npg),4)max_npg
03:02:42   8  ,ROUND(SUM(npg),4)sum_npg
03:02:42   9  FROM hdp
03:02:42  10  GROUP BY pair,dhr
03:02:42  11  -- I want more than 1 pip / hr which is 12 pips:
03:02:42  12  HAVING AVG(npg) > 0.0012
03:02:42  13  ORDER BY pair,dhr
03:02:42  14  /

PAIR		DHR   COUNT_NPG    MIN_NPG    AVG_NPG STDDEV_NPG    MAX_NPG    SUM_NPG
--------------- ---- ---------- ---------- ---------- ---------- ---------- ----------
aud_usd 	4_05	     96     -.0286	.0013	    .008      .0272	  .121
aud_usd 	4_19	     95     -.0198	.0013	    .007      .0168	 .1211
aud_usd 	4_20	     96     -.0187	.0013	   .0069      .0175	 .1279
aud_usd 	4_21	     96     -.0189	.0013	   .0074      .0151	 .1264
aud_usd 	4_22	     96     -.0224	.0017	   .0081      .0201	 .1618
aud_usd 	4_23	     96     -.0223	.0017	   .0082      .0199	  .166
aud_usd 	5_00	     96     -.0236	.0014	   .0078      .0178	 .1337
aud_usd 	5_01	     97     -.0213	.0014	   .0079	.02	 .1317
gbp_usd 	3_12	     94     -.0157	.0012	   .0056       .021	 .1128
usd_cad 	5_13	     96     -.0135	.0012	   .0057      .0182	 .1163

10 rows selected.

Elapsed: 00:00:00.62
03:02:43 SQL> 
03:02:43 SQL> 
03:02:43 SQL> exit
Disconnected from Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options
